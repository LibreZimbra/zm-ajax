<project name="ant-global" xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:antcontrib="antlib:net.sf.antcontrib">
    <!-- Set properties that can be used in all projects. -->
    <dirname property="zimbra.root.dir" file="${ant.file.ant-global}/../"/>
    <!-- Java -->
    <property name="javac.target" value="1.8"/>
    <!-- base path for ivy cache, local repository, ant libraries, etc -->

    <property name="dev.home"  value="${user.home}"/>

    <!-- Add "init-ivy" depends to your "resolve" target and the following will
         automatically download and install ivy if necessary. -->
    <property name="ivy.jar.dir" location="${dev.home}/.ant/lib" />
    <property name="ivy.install.version" value="2.3.0" />
    <property name="ivy.jar.file" value="${ivy.jar.dir}/ivy-2.3.0.jar" />
    <property name="ivy.status" value="integration" />
    <property name="ivy.organisation" value="zimbra" />
    <property name="ivy.publish.src.artifacts.pattern" value="build/[artifact]-[revision].[ext]" />
    <property name="ivy.deliver.ivy.pattern" value="${dev.home}/.zcs-deps/[organisation]/[module]/[module]-[revision].[ext]" />
    <property name="ivy.module" value="${ant.project.name}" />

    <target name="test.if.ivy.available">
      <condition property="ivy.installed">
        <available file="${ivy.jar.file}" type="file"/>
      </condition>
    </target>

    <target name="download-ivy" description="Install ivy" unless="ivy.installed" depends="test.if.ivy.available">
      <mkdir dir="${ivy.jar.dir}"/>
      <get src="https://repo1.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar"
         dest="${ivy.jar.file}" usetimestamp="true"/>
    </target>

    <target name="init-ivy" depends="download-ivy">
      <!-- If ivy is not downloaded yet, try to load ivy here from ivy home. -->
        <path id="ivy.lib.path">
            <fileset dir="${ivy.jar.dir}" includes="*.jar"/>
        </path>
        <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path"/>
    </target>
    <!-- common resolve target that should work to resolve dependencies based on ivy.xml for most projects -->
    <target name="resolve" depends="init-ivy" description="resolve dependencies">
      <ivy:settings id="dev.settings" file="build-ivysettings.xml"/>
      <ivy:resolve settingsRef="dev.settings" />
      <ivy:cachepath pathid="class.path" />
    </target>

    <target name="3rd-party-defines"  description="Declare 3rd party ANT tasks" depends="resolve">
      <taskdef uri="antlib:net.sf.antcontrib" classpathref="class.path"/>
    </target>

    <!-- Ignore the classpath from the shell running ant.  This avoids dependency
      on the user's environment and suppresses the warning about includeAntRuntime. -->
    <property name="build.sysclasspath" value="ignore"/>

    <!-- Standard directory paths -->
    <property name="src.dir" location="src" />
    <property name="src.java.dir" location="src/java" />
    <property name="src.bin.dir" location="src/bin" />
    <property name="src.libexec.dir" location="src/libexec" />
    <property name="src.zimlet.dir" location="src/zimlet" />
    <property name="jars.dir" location="jars" />
    <property name="build.dir" location="build" />
    <property name="build.tmp.dir" location="${build.dir}/tmp" />
    <property name="dist.dir" location="${build.dir}/dist" />
    <property name="dist.lib.dir" location="${dist.dir}/lib"/>
    <property name="dist.lib.ext.dir" location="${dist.lib.dir}/ext"/>
    <property name="build.classes.dir" location="${build.dir}/classes" />
    <property name="build.instrumented.dir" location="${build.dir}/classes-inst" />
    <property name="build.coverage.dir" location="${build.dir}/coverage" />
    <property name="build.zimlet.dir" location="${build.dir}/zimlet" />

    <path id="all.java.path">
        <pathelement location="${src.java.dir}" />
    </path>
    <!-- Standard build dependencies path -->
    <property name="build.deps.dir" location="${dev.home}/.zcs-deps"/>

    <!-- Standard install paths -->
    <property name="zimbra.home.dir" location="/opt/zimbra" />
    <property name="jetty.home.dir" location="${zimbra.home.dir}/jetty"/>
    <property name="jetty.webapps.dir" location="${jetty.home.dir}/webapps"/>
    <property name="common.jars.dir" location="${zimbra.home.dir}/lib/jars"/>
    <property name="jetty.endorsed.jars.dir" location="${jetty.home.dir}/common/endorsed"/>
    <property name="jetty.common.jars.dir" location="${jetty.home.dir}/common/lib"/>
    <property name="ext-common.jars.dir" location="${zimbra.home.dir}/lib/ext-common"/>
    <property name="common.sourcejars.dir" location="${zimbra.home.dir}/jars-src"/>

    <!-- Platform -->
    <condition property="native.os" value="MacOSX">
        <os name="Mac OS X"/>
    </condition>
    <condition property="native.os" value="Linux">
        <os name="Linux"/>
    </condition>
    <condition property="native.so" value="jnilib">
        <os name="Mac OS X"/>
    </condition>
    <condition property="native.so" value="so">
        <not><os name="Mac OS X"/></not>
    </condition>
    <condition property="native.arch" value="">
        <os name="Mac OS X"/>
    </condition>
    <condition property="native.arch" value=".${os.arch}">
        <not>
            <os name="Mac OS X"/>
        </not>
    </condition>
    <condition property="is-windows">
        <os family="windows"/>
    </condition>
    <condition property="is-unix">
        <not><os family="windows"/></not>
    </condition>

    <target name="require-version">
      <fail message="Missing build version. use ant proper ZCS version like -Dzimbra.buildinfo.version=8.7.6_GA_1001">
       <condition>
         <not>
           <isset property="zimbra.buildinfo.version"/>
         </not>
       </condition>
      </fail>
      <echo message="Using version ${zimbra.buildinfo.version}"/>
    </target>

    <target name="set-dev-version" depends="require-version,3rd-party-defines">
      <antcontrib:if>
        <not>
          <isset property="jar.file"/>
        </not>
        <then>
          <exec executable="git" outputproperty="git.timestamp">
            <arg value="log"/>
            <arg value="-1"/>
            <arg value="--pretty=format:%at"/>
          </exec>

          <!-- Build version -->
          <tstamp/>
          <antcontrib:propertyregex property="zimbra.buildinfo.majorversion"
                                    input="${zimbra.buildinfo.version}"
                                    regexp="([0-9]+)\.([0-9]+)\.([0-9]+)"
                                    select="\1"
                                    casesensitive="false" />

          <antcontrib:propertyregex property="zimbra.buildinfo.minorversion"
                                    input="${zimbra.buildinfo.version}"
                                    regexp="([0-9]+)\.([0-9]+)\.([0-9]+)"
                                    select="\2"
                                    casesensitive="false" />

          <antcontrib:propertyregex property="zimbra.buildinfo.microversion"
                                    input="${zimbra.buildinfo.version}"
                                    regexp="([0-9]+)\.([0-9]+)\.([0-9]+)"
                                    select="\3"
                                    casesensitive="false" />

          <antcontrib:propertyregex property="zimbra.buildinfo.relclass"
                                    defaultValue="GA"
                                    input="${zimbra.buildinfo.version}"
                                    regexp="([0-9]+)\.([0-9]+)\.([0-9]+)_([A-Z]+)"
                                    select="\4"
                                    casesensitive="false" />

          <antcontrib:propertyregex property="zimbra.buildinfo.buildnum"
                                    input="${zimbra.buildinfo.version}"
                                    regexp="([0-9]+)\.([0-9]+)\.([0-9]+)_([A-Z]+)_([0-9]+)"
                                    select="\5"
                                    casesensitive="false" />

          <condition property="zimbra.buildinfo.relnum" value="0">
            <not><isset property="${zimbra.buildinfo.relnum}"/></not>
          </condition>

          <condition property="zimbra.buildinfo.type" value="">
            <not><isset property="${zimbra.buildinfo.type}"/></not>
          </condition>

          <condition property="zimbra.buildinfo.release" value="${user.name}">
            <not><isset property="${zimbra.buildinfo.release}"/></not>
          </condition>

          <condition property="zimbra.buildinfo.date" value="${DSTAMP}-${TSTAMP}">
            <not><isset property="${zimbra.buildinfo.date}"/></not>
          </condition>

          <condition property="zimbra.buildinfo.host" value="${zimbra.server.hostname}">
            <not><isset property="${zimbra.buildinfo.host}"/></not>
          </condition>

          <property name="zimbra.buildinfo.microtag" value="${zimbra.buildinfo.microversion}_${zimbra.buildinfo.relclass}"/>

          <property name="zimbra.buildinfo.all"
                    value="Version: ${zimbra.buildinfo.version}; Type: ${zimbra.buildinfo.type}; Release: ${zimbra.buildinfo.release}; Built: ${zimbra.buildinfo.date}; Host: ${zimbra.buildinfo.host}"/>

          <property name="dev.version" value="${zimbra.buildinfo.majorversion}.${zimbra.buildinfo.minorversion}.${zimbra.buildinfo.microversion}.${git.timestamp}"/>
          <property name="jar.file" value="${ant.project.name}-${dev.version}.jar"/>
        </then>
      </antcontrib:if>
    </target>

    <target name="clean">
        <delete dir="${build.dir}"/>
        <delete dir="${dist.dir}"/>
    </target>

    <target name="build-init" depends="require-version">
      <mkdir dir="${build.classes.dir}"/>
      <mkdir dir="${dist.dir}"/>
    </target>

    <target name="compile" depends="build-init,resolve,3rd-party-defines" description="Compiles from src/java into build/classes.">
        <mkdir dir="${build.classes.dir}" />
        <javac destdir="${build.classes.dir}" debug="true" classpathref="class.path" target="${javac.target}" encoding="utf-8">
            <src refid="all.java.path" />
        </javac>
    </target>

    <target name="generate-jar-version" description="Creates the Version class that prints the version of the jarfile.  This class is the Main-Class in the jarfile's manifest." depends="3rd-party-defines">
        <fail unless="build.dir" />
        <fail unless="build.classes.dir" />

        <antcontrib:if>
            <not><available file="${build.dir}/buildinfo/com/zimbra/buildinfo/Version.java"/></not>
            <then>
                <mkdir dir="${build.dir}/buildinfo/com/zimbra/buildinfo"/>
                <echo file="${build.dir}/buildinfo/com/zimbra/buildinfo/Version.java">
                    package com.zimbra.buildinfo;

                    public class Version {

                    public static void main(String[] args) {
                        Package p = Version.class.getPackage();
                        System.out.println("Implementation-Title: " + p.getImplementationTitle() +
                            "\nImplementation-Version: " + p.getImplementationVersion() +
                            "\nImplementation-Vendor: " + p.getImplementationVendor() + "\n");
                        }
                    }
                </echo>
            </then>
        </antcontrib:if>
        <javac destdir="${build.classes.dir}" debug="true" target="${javac.target}" srcdir="${build.dir}/buildinfo" />
    </target>

    <target name="zimbra-jar" depends="generate-jar-version,set-dev-version" description="Builds a standard jar file that prints its version info when executed.  Optionally sets the Zimbra-Extension-Class attribute in the manifest if the zimbra.extension.class property is set.">
        <condition property="jar.file" value="${ant.project.name}-${dev.version}.jar">
          <not><isset property="jar.file"/></not>
        </condition>
        <fail unless="implementation.title"/>
        <antcontrib:if>
          <not>
            <isset property="jar.build.dir"/>
          </not>
          <then>
            <property name="jar.build.dir" value="${build.classes.dir}"/>
          </then>
        </antcontrib:if>
        <antcontrib:if>
          <not>
            <isset property="excludes"/>
          </not>
          <then>
            <property name="excludes" value=""/>
          </then>
        </antcontrib:if>
        <antcontrib:if>
          <not>
            <isset property="includes"/>
          </not>
          <then>
            <property name="includes" value=""/>
          </then>
        </antcontrib:if>
        <echo>building jar from ${jar.build.dir}</echo>
        <antcontrib:if>
            <isset property="zimbra.extension.class"/>
            <then>
            <jar destfile="${build.dir}/${jar.file}" basedir="${jar.build.dir}" includes="${includes}" excludes="${excludes}">
                <manifest>
                    <attribute name="Main-Class" value="com.zimbra.buildinfo.Version" />
                    <attribute name="Implementation-Vendor" value="Zimbra Software, LLC"/>
                    <attribute name="Implementation-Title" value="${implementation.title}"/>
                    <attribute name="Implementation-Version" value="${zimbra.buildinfo.version}"/>
                    <attribute name="Specification-Vendor" value="Zimbra Software, LLC"/>
                    <attribute name="Specification-Title" value="Zimbra Collaboration Suite"/>
                    <attribute name="Specification-Version" value="${zimbra.buildinfo.majorversion}.${zimbra.buildinfo.minorversion}.${zimbra.buildinfo.microversion}"/>
                    <attribute name="Zimbra-Extension-Class" value="${zimbra.extension.class}"/>
                </manifest>
            </jar>
            </then>
            <else>
            <jar destfile="${build.dir}/${jar.file}" basedir="${jar.build.dir}" includes="${includes}" excludes="${excludes}">
                <manifest>
                    <attribute name="Main-Class" value="com.zimbra.buildinfo.Version" />
                    <attribute name="Implementation-Vendor" value="Zimbra Software, LLC"/>
                    <attribute name="Implementation-Title" value="${implementation.title}"/>
                    <attribute name="Implementation-Version" value="${zimbra.buildinfo.version}"/>
                    <attribute name="Specification-Vendor" value="Zimbra Software, LLC"/>
                    <attribute name="Specification-Title" value="Zimbra Collaboration Suite"/>
                    <attribute name="Specification-Version" value="${zimbra.buildinfo.majorversion}.${zimbra.buildinfo.minorversion}.${zimbra.buildinfo.microversion}"/>
                </manifest>
            </jar>
            </else>
        </antcontrib:if>
    </target>

    <target name="zimbra-zip" depends="set-dev-version" description="Builds zip file from build directory">
      <condition property="zip.file" value="${ant.project.name}-${dev.version}.zip">
        <not><isset property="zip.file"/></not>
      </condition>

      <antcontrib:if>
        <not>
          <isset property="zip.build.dir"/>
        </not>
        <then>
          <property name="zip.build.dir" value="${build.dir}"/>
        </then>
      </antcontrib:if>
      <antcontrib:if>
        <not>
          <isset property="excludes"/>
        </not>
        <then>
          <property name="excludes" value="${zip.file}"/>
        </then>
      </antcontrib:if>
      <antcontrib:if>
        <not>
          <isset property="includes"/>
        </not>
        <then>
          <property name="includes" value=""/>
        </then>
      </antcontrib:if>

      <zip destfile="${build.dir}/${zip.file}" update="true" basedir="${zip.build.dir}" includes="${includes}" excludes="${excludes}" />
    </target>

    <target name="clean-cache" description="Delete ivy cache">
        <delete dir="${dev.home}/.ivy2/cache/zimbra/${ant.project.name}"/>
        <delete dir="${dev.home}/.zcs-deps/zimbra/${ant.project.name}"/>
        <delete>
            <fileset dir="${dev.home}/.ivy2/cache" includes="*${ant.project.name}*"/>
        </delete>
    </target>

    <target name="publish-local" depends="clean-cache,jar,set-dev-version,init-ivy">
      <ivy:publish settingsRef="dev.settings" pubrevision="${dev.version}" resolver="local" overwrite="true" />
    </target>

    <target name="dist.dependencies">
         <antcall target="depend.${ant.project.name}"/>
    </target>
</project>
